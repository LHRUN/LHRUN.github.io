<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="songlh">







<title>微信小程序蓝牙控制开门 | LH&#39;BLOG</title>



    <link rel="icon" href="/favicon.png">



<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono&display=swap');
</style>



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    




    <!-- scripts list from _config.yml -->
    
    <script src="/js/frame.js"></script>
    










  <meta name="generator" content="Hexo 6.2.0"></head>
  <body>
    <div class="mask-border">
    </div>

    <div class="wrapper">

      <div class="header">
  <div class="flex-container">
    <div class="header-inner">
      <div class="site-brand-container">
        <a href="/">
          
            <img loading="lazy" class="logo-img" src="/logo.png" alt="logo_image">
          
        </a>
      </div>
      <div id="menu-btn" class="menu-btn" onclick="toggleMenu()">
        Menu
      </div>
      <nav class="site-nav">
        <ul class="menu-list">
          
            
              <li class="menu-item">
                <a href="/">Home</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/categories/gallery/">Posts</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/archives/">Archive</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/tag/">Tag</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/about/">About</a>
              </li> 
                   
          
          
            <li class="menu-item search-btn">
              <a href="#">Search</a>
            </li>
          
        </ul>
      </nav>
    </div>
  </div>
</div>


      <div class="main">
        <div class="flex-container">
          <article id="post">

  
    <div class="post-head">
    <div class="post-info">
        <div class="tag-list">
            
                
                    <span class="post-tag">
                        <a href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">
                            微信小程序
                        </a>
                    </span>    
                
                    <span class="post-tag">
                        <a href="/tags/%E8%93%9D%E7%89%99/">
                            蓝牙
                        </a>
                    </span>    
                           
            
        </div>
        <div class="post-title">
            
            
                微信小程序蓝牙控制开门
            
            
        </div>
        <span class="post-date">
            1月 10, 2020
        </span>
    </div>
    <div class="post-img">
        
            <img loading="lazy" src="https://s1.ax1x.com/2022/09/11/vXAIVP.jpg" alt="featured_image">
              
    </div>
</div>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.6.0/styles/base16/gruvbox-light-medium.min.css">
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<div class="post-content">
    <h2 id="小程序低功耗蓝牙控制开门"><a href="#小程序低功耗蓝牙控制开门" class="headerlink" title="小程序低功耗蓝牙控制开门"></a>小程序低功耗蓝牙控制开门</h2><h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><blockquote>
<ol>
<li>初始化蓝牙模块<code>openBluetoothAdapter</code></li>
<li>获取本机蓝牙适配器状态<code>getBluetoothAdapterState</code></li>
<li>搜索外围蓝牙设备<code>startBluetoothDevicesDiscovery</code></li>
<li>监听寻找到新设备<code>onBluetoothDeviceFound</code></li>
<li>连接蓝牙<code>createBLEConnection</code></li>
<li>获取蓝牙设备的服务<code>getBLEDeviceServices</code></li>
<li>获取服务中的特征值<code>getBLEDeviceCharacteristics</code></li>
<li>启用特征值变化时的notify功能<code>notifyBLECharacteristicValueChange</code></li>
<li>向蓝牙设备写入数据<code>writeBLECharacteristicValue</code></li>
<li>关闭蓝牙模块<code>closeBluetoothAdapter</code></li>
</ol>
</blockquote>
<h3 id="1-初始化蓝牙模块"><a href="#1-初始化蓝牙模块" class="headerlink" title="1. 初始化蓝牙模块"></a>1. 初始化蓝牙模块</h3><ul>
<li>初始化蓝牙模块使用的是：<code>wx.openBluetoothAdapter</code>，初始化之前对蓝牙功能做一个判断，看手机微信版本是否支持此功能</li>
<li>初始化之前需要关闭蓝牙模块：<code>wx.closeBluetoothAdapter</code>，否则容易搜索失败<pre><code class="highlight js"><span class="keyword">var</span> _this = <span class="variable language_">this</span>
<span class="keyword">if</span> (!wx.<span class="property">openBluetoothAdapter</span>) &#123;
  wx.<span class="title function_">showModal</span>(&#123;
    <span class="attr">title</span>: <span class="string">&#x27;提示&#x27;</span>,
    <span class="attr">showCancel</span>: <span class="literal">false</span>,
    <span class="attr">content</span>: <span class="string">&#x27;当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试&#x27;</span>,
  &#125;)
&#125; <span class="keyword">else</span> &#123;
  wx.<span class="title function_">closeBluetoothAdapter</span>(&#123;
    <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
      wx.<span class="title function_">openBluetoothAdapter</span>(&#123; <span class="comment">// 初始化蓝牙模块</span>
        <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;初始化蓝牙成功&#x27;</span>)
          _this.<span class="title function_">getBluetoothAdapterState</span>()
        &#125;,
        <span class="attr">fail</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;
          <span class="variable language_">console</span>.<span class="title function_">log</span>(err)
        &#125;
      &#125;)
    &#125;,
  &#125;)
&#125;</code></pre></li>
</ul>
<h3 id="2-获取本机蓝牙适配器状态"><a href="#2-获取本机蓝牙适配器状态" class="headerlink" title="2. 获取本机蓝牙适配器状态"></a>2. 获取本机蓝牙适配器状态</h3><ul>
<li>获取本机蓝牙适配器状态使用的是<code>wx.getBluetoothAdapterState</code>，调用成功后，会返回两个参数<ul>
<li><code>discovering</code>判断是否正在搜索设备</li>
<li><code>available</code>判断蓝牙适配器是否可用<pre><code class="highlight js"><span class="attr">getBluetoothAdapterState</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;
  <span class="keyword">var</span> _this = <span class="variable language_">this</span>
  wx.<span class="title function_">getBluetoothAdapterState</span>(&#123;
    <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
      <span class="keyword">if</span> (res.<span class="property">available</span> == <span class="literal">false</span>) &#123;
        wx.<span class="title function_">showToast</span>(&#123;
          <span class="attr">title</span>: <span class="string">&#x27;设备无法开启蓝牙连接&#x27;</span>,
          <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,
          <span class="attr">duration</span>: <span class="number">2000</span>
        &#125;)
        wx.<span class="title function_">closeBluetoothAdapter</span>()
      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.<span class="property">discovering</span> == <span class="literal">false</span>) &#123;
        _this.<span class="title function_">startBluetoothDevicesDiscovery</span>() <span class="comment">// 开启搜索外围设备</span>
      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.<span class="property">available</span>)&#123;
        _this.<span class="title function_">startBluetoothDevicesDiscovery</span>() <span class="comment">// 蓝牙适配器正常，去执行搜索外围设备</span>
      &#125;
    &#125;
  &#125;)
&#125;</code></pre></li>
</ul>
</li>
</ul>
<h3 id="3-搜索外围蓝牙设备"><a href="#3-搜索外围蓝牙设备" class="headerlink" title="3. 搜索外围蓝牙设备"></a>3. 搜索外围蓝牙设备</h3><ul>
<li>搜索外围蓝牙设备使用的是<code>wx.startBluetoothDevicesDiscovery</code>，连接设备后一定要使用<code>wx.stopBluetoothDevicesDiscovery</code>停止搜索<pre><code class="highlight js"><span class="attr">startBluetoothDevicesDiscovery</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;
    <span class="keyword">var</span> _this = <span class="variable language_">this</span>
    wx.<span class="title function_">startBluetoothDevicesDiscovery</span>(&#123;
      <span class="attr">allowDuplicatesKey</span>: <span class="literal">false</span>,
      <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
        <span class="keyword">if</span>(!res.<span class="property">isDiscovering</span>)&#123; <span class="comment">// 是否在搜索设备</span>
          _this.<span class="title function_">getBluetoothAdapterState</span>()
        &#125;<span class="keyword">else</span>&#123;
          _this.<span class="title function_">onBluetoothDeviceFound</span>() <span class="comment">// 搜索成功后，执行监听设备的api</span>
        &#125;
      &#125;,
      <span class="attr">fail</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;
        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;蓝牙搜寻失败&quot;</span>)
        wx.<span class="title function_">stopBluetoothDevicesDiscovery</span>() <span class="comment">// 没有搜索到设备</span>
        wx.<span class="title function_">closeBluetoothAdapter</span>() <span class="comment">// 关闭蓝牙模块</span>
      &#125;
    &#125;)
&#125;</code></pre></li>
</ul>
<h3 id="4-监听寻找到新设备"><a href="#4-监听寻找到新设备" class="headerlink" title="4. 监听寻找到新设备"></a>4. 监听寻找到新设备</h3><ul>
<li>监听寻找到新设备使用的是<code>wx.onBluetoothDeviceFound</code>，每搜到一个新设备就会触发一次，然后返回一个搜索到的设备列表，包含了设备名称和mac地址，一般都是使用设备名称和mac地址来匹配设备的<ul>
<li>安卓和IOS返回的deviceId不一样，安卓返回的是mac地址，IOS返回的是UUID，如果想通过mac地址来匹配设备，可以让mac地址存储在<code>advertisData</code>数据段中，然后解析这个数据段得到mac地址</li>
<li>我使用的是通过设备名称来进行匹配<pre><code class="highlight js"><span class="attr">onBluetoothDeviceFound</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;
  <span class="keyword">var</span> _this = <span class="variable language_">this</span>
  wx.<span class="title function_">onBluetoothDeviceFound</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;
    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;res.<span class="property">devices</span>.<span class="property">length</span>; i++)&#123;
      <span class="keyword">if</span>(res.<span class="property">devices</span>[i].<span class="property">name</span> == <span class="string">&quot;设备名称&quot;</span> || res.<span class="property">devices</span>[i].<span class="property">localName</span> == <span class="string">&quot;设备名称&quot;</span>)&#123;
        _this.<span class="title function_">setData</span>(&#123;
          <span class="attr">deviceId</span>: res.<span class="property">devices</span>[i].<span class="property">deviceId</span> <span class="comment">// 把匹配设备的deviceId存到data中</span>
        &#125;)
        wx.<span class="title function_">stopBluetoothDevicesDiscovery</span>() <span class="comment">// 匹配到设备后关闭搜索</span>
        _this.<span class="title function_">createBLEConnection</span>() <span class="comment">// 连接蓝牙</span>
      &#125;
    &#125;
  &#125;)
&#125;</code></pre></li>
</ul>
</li>
</ul>
<h3 id="5-连接蓝牙"><a href="#5-连接蓝牙" class="headerlink" title="5. 连接蓝牙"></a>5. 连接蓝牙</h3><ul>
<li>连接蓝牙使用的是<code>wx.createBLEConnection</code>，连接蓝牙是通过<code>deviceId</code>连接，<code>deviceId</code>是通过<code>wx.onBluetoothDeviceFound</code>获取的</li>
<li>连接蓝牙容易失败，所以可以定一个变量<code>count</code>用来计算连接的次数，如果超出特定的次数就判断为连接失败，关闭蓝牙模块<pre><code class="highlight js"><span class="attr">createBLEConnection</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// 连接低功耗蓝牙</span>
  <span class="keyword">var</span> _this = <span class="variable language_">this</span>
  wx.<span class="title function_">createBLEConnection</span>(&#123;
    <span class="attr">deviceId</span>: _this.<span class="property">data</span>.<span class="property">deviceId</span>,
    <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
      _this.<span class="title function_">getBLEDeviceServices</span>()
    &#125;,
    <span class="attr">fail</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;
      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接失败&quot;</span>)
      <span class="keyword">if</span>( count &lt; <span class="number">6</span> )&#123;
        count++
        _this.<span class="title function_">createBLEConnection</span>()
      &#125;<span class="keyword">else</span>&#123;
        wx.<span class="title function_">closeBluetoothAdapter</span>() <span class="comment">// 连接失败关闭蓝牙模块</span>
      &#125;
    &#125;
  &#125;)
&#125;</code></pre></li>
</ul>
<h3 id="6-获取蓝牙设备的服务"><a href="#6-获取蓝牙设备的服务" class="headerlink" title="6. 获取蓝牙设备的服务"></a>6. 获取蓝牙设备的服务</h3><ul>
<li>获取蓝牙设备的服务列表使用的是<code>wx.getBLEDeviceServices</code><pre><code class="highlight js"><span class="attr">getBLEDeviceServices</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;
  <span class="keyword">var</span> _this = <span class="variable language_">this</span>
  wx.<span class="title function_">getBLEDeviceServices</span>(&#123;
    <span class="attr">deviceId</span>: _this.<span class="property">data</span>.<span class="property">deviceId</span>,
    <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
      <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;res.<span class="property">services</span>.<span class="property">length</span>; i++)&#123;
        <span class="comment">// 如果提前得知可以直接判断，如果不知道可以用蓝牙工具看一下服务所需的功能</span>
        <span class="keyword">if</span>(res.<span class="property">services</span>[i].<span class="property">uuid</span> == _this.<span class="property">data</span>.<span class="property">service</span>)&#123;
          _this.<span class="title function_">setData</span>(&#123;
            <span class="attr">serviceId</span>: res.<span class="property">services</span>[i].<span class="property">uuid</span>
          &#125;)
          _this.<span class="title function_">getBLEDeviceCharacteristics</span>()
        &#125;   
      &#125;
    &#125;,
    <span class="attr">fail</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;
      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取服务失败&quot;</span>)
      wx.<span class="title function_">closeBluetoothAdapter</span>() <span class="comment">// 关闭蓝牙模块</span>
    &#125;
  &#125;)
&#125;,</code></pre></li>
</ul>
<h3 id="7-获取服务中的特征值"><a href="#7-获取服务中的特征值" class="headerlink" title="7. 获取服务中的特征值"></a>7. 获取服务中的特征值</h3><ul>
<li>获取服务中的特征值使用的是<code>wx.getBLEDeviceCharacteristics</code><pre><code class="highlight js"><span class="attr">getBLEDeviceCharacteristics</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// 获取服务中的特征值</span>
  <span class="keyword">var</span> _this = <span class="variable language_">this</span>
  wx.<span class="title function_">getBLEDeviceCharacteristics</span>(&#123;
    <span class="attr">deviceId</span>: _this.<span class="property">data</span>.<span class="property">deviceId</span>,
    <span class="attr">serviceId</span>: _this.<span class="property">data</span>.<span class="property">serviceId</span>,
    <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
      <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;res.<span class="property">characteristics</span>.<span class="property">length</span>; i++)&#123;
        <span class="keyword">let</span> model = res.<span class="property">characteristics</span>[i]
        <span class="keyword">if</span> ((model.<span class="property">properties</span>.<span class="property">notify</span> || model.<span class="property">properties</span>.<span class="property">indicate</span>) &amp;&amp; (model.<span class="property">properties</span>.<span class="property">read</span> &amp;&amp; model.<span class="property">properties</span>.<span class="property">write</span>))&#123;
          _this.<span class="title function_">setData</span>(&#123;
            <span class="attr">characteristicId</span>: model.<span class="property">uuid</span>
          &#125;)
          _this.<span class="title function_">notifyBLECharacteristicValueChange</span>()
        &#125;
      &#125;
    &#125;,
    <span class="attr">fail</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;
      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取服务中的特征值失败&quot;</span>)
      wx.<span class="title function_">closeBluetoothAdapter</span>() <span class="comment">// 关闭蓝牙模块</span>
    &#125;
  &#125;)
&#125;,</code></pre></li>
</ul>
<h3 id="8-启用特征值变化时的notify功能"><a href="#8-启用特征值变化时的notify功能" class="headerlink" title="8. 启用特征值变化时的notify功能"></a>8. 启用特征值变化时的notify功能</h3><ul>
<li>启用特征值变化时的notify功能使用的是<code>wx.notifyBLECharacteristicValueChange</code><pre><code class="highlight js"><span class="attr">notifyBLECharacteristicValueChange</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// 启用蓝牙特征值变化时的notify功能</span>
    <span class="keyword">var</span> _this = <span class="variable language_">this</span>
    wx.<span class="title function_">notifyBLECharacteristicValueChange</span>(&#123;
      <span class="attr">deviceId</span>: _this.<span class="property">data</span>.<span class="property">deviceId</span>,
      <span class="attr">serviceId</span>: _this.<span class="property">data</span>.<span class="property">serviceId</span>,
      <span class="attr">characteristicId</span>: _thisa.<span class="property">characteristicId</span>,
      <span class="attr">state</span>: <span class="literal">true</span>,
      <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
        wx.<span class="title function_">onBLECharacteristicValueChange</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;
            <span class="variable language_">console</span>.<span class="title function_">log</span>(如果要打印需要从arraybuffer格式转为字符串或<span class="number">16</span>进制)
        &#125;)
        _this.<span class="title function_">writeBLECharacteristicValue</span>() <span class="comment">// 向蓝牙设备写入数据</span>
      &#125;,
      <span class="attr">fail</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;
        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;启用BLE蓝牙特征值变化时的notify功能错误&quot;</span>)
        wx.<span class="title function_">closeBluetoothAdapter</span>() <span class="comment">// 关闭蓝牙模块</span>
      &#125;
    &#125;)</code></pre></li>
</ul>
<h3 id="9-向蓝牙设备写入数据"><a href="#9-向蓝牙设备写入数据" class="headerlink" title="9. 向蓝牙设备写入数据"></a>9. 向蓝牙设备写入数据</h3><ul>
<li>向蓝牙设备写入数据<code>wx.writeBLECharacteristicValue</code>，这时候就是输入提前设定好的指令<pre><code class="highlight js"><span class="attr">writeBLECharacteristicValue</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// 向蓝牙设备写入数据</span>
  <span class="keyword">var</span> _this = <span class="variable language_">this</span>
  wx.<span class="title function_">writeBLECharacteristicValue</span>(&#123;
    <span class="attr">deviceId</span>: _this.<span class="property">data</span>.<span class="property">deviceId</span>,
    <span class="attr">serviceId</span>: _this.<span class="property">data</span>.<span class="property">serviceId</span>,
    <span class="attr">characteristicId</span>: _this.<span class="property">data</span>.<span class="property">characteristicId</span>,
    <span class="attr">value</span>: buffer, <span class="comment">// 这个输入的指令，需要转换成ArrayBuffer</span>
    <span class="attr">success</span>: <span class="function"><span class="params">res</span> =&gt;</span> &#123;
      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;成功&quot;</span>)
      wx.<span class="title function_">closeBluetoothAdapter</span>() <span class="comment">// 关闭蓝牙模块</span>
    &#125;,
    <span class="attr">fail</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;
      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;输入指令失败&quot;</span>)
      wx.<span class="title function_">closeBluetoothAdapter</span>() <span class="comment">// 关闭蓝牙模块</span>
    &#125;
  &#125;)
&#125;</code></pre></li>
</ul>
<h3 id="转换格式"><a href="#转换格式" class="headerlink" title="转换格式"></a>转换格式</h3><ul>
<li><p>字符串转为arraybuffer</p>
<pre><code class="highlight js"><span class="attr">string2buffer</span>: <span class="keyword">function</span> (<span class="params">str</span>) &#123;
    <span class="comment">// 首先将字符串转为16进制</span>
    <span class="keyword">let</span> val = <span class="string">&quot;&quot;</span>
    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++) &#123;
      <span class="keyword">if</span> (val === <span class="string">&#x27;&#x27;</span>) &#123;
        val = str.<span class="title function_">charCodeAt</span>(i).<span class="title function_">toString</span>(<span class="number">16</span>)
      &#125; <span class="keyword">else</span> &#123;
        val += <span class="string">&#x27;,&#x27;</span> + str.<span class="title function_">charCodeAt</span>(i).<span class="title function_">toString</span>(<span class="number">16</span>)
      &#125;
    &#125;
    <span class="comment">// 将16进制转化为ArrayBuffer</span>
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(val.<span class="title function_">match</span>(<span class="regexp">/[\da-f]&#123;2&#125;/gi</span>).<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">h</span>) &#123;
      <span class="keyword">return</span> <span class="built_in">parseInt</span>(h, <span class="number">16</span>)
    &#125;)).<span class="property">buffer</span>
&#125;</code></pre>
</li>
<li><p>arraybuffer转为字符串</p>
<pre><code class="highlight js"><span class="keyword">function</span> <span class="title function_">ab2str</span>(<span class="params">u,f</span>) &#123;
   <span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Blob</span>([u]);
   <span class="keyword">var</span> r = <span class="keyword">new</span> <span class="title class_">FileReader</span>();
    r.<span class="title function_">readAsText</span>(b, <span class="string">&#x27;utf-8&#x27;</span>);
    r.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>)&#123;<span class="keyword">if</span>(f)f.<span class="title function_">call</span>(<span class="literal">null</span>,r.<span class="property">result</span>)&#125;
&#125;</code></pre></li>
</ul>
<h3 id="蓝牙遇见的坑"><a href="#蓝牙遇见的坑" class="headerlink" title="蓝牙遇见的坑"></a>蓝牙遇见的坑</h3><ul>
<li>1.苹果手机有时候输入指令会显示发送成功，但是设备并没有反应<ul>
<li><pre><code>解决方法：把需要输入的指令改成每10毫秒输入一个字节
</code></pre>
</li>
<li>如果改成每10毫秒输入一个字节，安卓手机就会频繁出现10008错误</li>
<li>针对这个问题我用了一个不太好的方法，我判断了一下手机的类型，如果是ios的就分10毫秒输入，如果是安卓的就一次性输入</li>
</ul>
</li>
<li>2.在调用<code>wx.onBluetoothDeviceFound</code>这个api时ios会监听两次，然后就会导致最后设备会有两次指令输入<ul>
<li>解决方法：我在搜索蓝牙设备之前做了一个定时器，然后用<code>getBluetoothDevices</code>来查看所有已搜索到的蓝牙，在这个里面做判断来连接蓝牙设备</li>
</ul>
</li>
<li>我上面的步骤没有把这些坑的解决步骤加上，如果碰见此类问题，可以自己在合适的位置修改一下</li>
</ul>
<h3 id="二维码"><a href="#二维码" class="headerlink" title="二维码"></a>二维码</h3><p>我自己做了一个小程序的蓝牙调试器，下面是小程序码，欢迎大家体验<br><img src="https://img-blog.csdnimg.cn/20200123154720532.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDcxOTI1OA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>

</div> 

<script>
    window.onload = detectors();
</script>
    <div class="post-footer">
    <div class="h-line-primary"></div>
    <nav class="post-nav">
        <div class="prev-item">
           
                <div class="icon arrow-left"></div>
                <div class="post-link">
                    <a href="/2021/04/13/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%BB%9A%E5%8A%A8%E6%97%A5%E5%8E%86%E7%BB%84%E4%BB%B6/">Prev</a>
                </div>
            
        </div>
        <div class="next-item">
            
        </div>
    </nav>
</div>

    <div class="post-toc">
  <div class="post-toc-wrap">
    <div class="post-toc-title">目录</div>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99%E6%8E%A7%E5%88%B6%E5%BC%80%E9%97%A8"><span class="toc-text">小程序低功耗蓝牙控制开门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-text">整体流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%93%9D%E7%89%99%E6%A8%A1%E5%9D%97"><span class="toc-text">1. 初始化蓝牙模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BA%E8%93%9D%E7%89%99%E9%80%82%E9%85%8D%E5%99%A8%E7%8A%B6%E6%80%81"><span class="toc-text">2. 获取本机蓝牙适配器状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%90%9C%E7%B4%A2%E5%A4%96%E5%9B%B4%E8%93%9D%E7%89%99%E8%AE%BE%E5%A4%87"><span class="toc-text">3. 搜索外围蓝牙设备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%9B%91%E5%90%AC%E5%AF%BB%E6%89%BE%E5%88%B0%E6%96%B0%E8%AE%BE%E5%A4%87"><span class="toc-text">4. 监听寻找到新设备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%BF%9E%E6%8E%A5%E8%93%9D%E7%89%99"><span class="toc-text">5. 连接蓝牙</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E8%8E%B7%E5%8F%96%E8%93%9D%E7%89%99%E8%AE%BE%E5%A4%87%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-text">6. 获取蓝牙设备的服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%E7%89%B9%E5%BE%81%E5%80%BC"><span class="toc-text">7. 获取服务中的特征值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%90%AF%E7%94%A8%E7%89%B9%E5%BE%81%E5%80%BC%E5%8F%98%E5%8C%96%E6%97%B6%E7%9A%84notify%E5%8A%9F%E8%83%BD"><span class="toc-text">8. 启用特征值变化时的notify功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%90%91%E8%93%9D%E7%89%99%E8%AE%BE%E5%A4%87%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">9. 向蓝牙设备写入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E6%A0%BC%E5%BC%8F"><span class="toc-text">转换格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E9%81%87%E8%A7%81%E7%9A%84%E5%9D%91"><span class="toc-text">蓝牙遇见的坑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-text">二维码</span></a></li></ol></li></ol>
  </div>
</div>

<script>
  const tocLinks = document.querySelectorAll('.toc-link')
  tocLinks.forEach((el) => {
    el.setAttribute('href', `#${el.innerText}`)
  })
</script>

    
      <div class="post-comment">

     

    
        <div id="disqus_thread"></div>
        <script>
            /**
            *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
            *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
            
            var disqus_config = function () {
                this.page.url = 'https://lhrun.github.io/2020/01/10/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%93%9D%E7%89%99%E6%8E%A7%E5%88%B6%E5%BC%80%E9%97%A8/';  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = '2020/01/10/微信小程序蓝牙控制开门/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                this.language = 'en'
            };
            
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://lhblog-1.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>   
     
    
    

</div>
     
  
</article>
        </div>
      </div>
      
      <div class="footer">
    <div class="flex-container">
        <div class="footer-text">
            
            
            
                Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
                
        </div>
    </div>
</div>

    </div>

    
      <div class="search-popup">
    <div class="search-popup-overlay">  
    </div>
    <div class="search-popup-window" >
        <div class="search-header">
            <div class="search-input-container">
              <input autocomplete="off" autocapitalize="off" maxlength="80"
                     placeholder="Search Anything" spellcheck="false"
                     type="search" class="search-input">
            </div>
            <div class="search-close-btn">
                <div class="icon close-btn"></div>
            </div>
        </div>
        <div class="search-result-container">
        </div>
    </div>
</div>

<script>
    const searchConfig = {
        path             : "/search.xml",
        top_n_per_article: "1",
        unescape         : "false",
        trigger: "auto",
        preload: "false"
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script>
<script src="/js/search.js"></script>
    
    

  </body>
</html>
