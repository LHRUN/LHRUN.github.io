<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="LH_R"><title>vue3å“åº”å¼åˆ†æ Â· LH'BLOG</title><meta name="description" content="vue3å“åº”å¼åˆ†æ
é¦–å…ˆå¯¹vue3å“åº”å¼åˆ†æä¹‹å‰ï¼Œéœ€è¦å¯¹å‰ç½®çŸ¥è¯†Proxyå’ŒReflectæœ‰æ‰€äº†è§£ï¼Œï¼Œå…³äºè¿™ä¸¤ä¸ªçŸ¥è¯†æˆ‘æ¨èçœ‹é˜®ä¸€å³°è€å¸ˆçš„ES6å…¥é—¨æ•™ç¨‹
vue3çš„å“åº”å¼æˆ‘æ˜¯ä»¥reactiveä¸ºå…¥å£è¿›è¡Œæ¢³ç†ï¼Œæµç¨‹å¦‚ä¸‹å›¾
æºç ä½ç½®ï¼šreactivity/src/...ï¼Œåˆ†å››éƒ¨åˆ†è§£æ


reactive"><meta name="keywords" content="Blog,åšå®¢,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.2.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">é¦–é¡µ</a></li><li> <a href="/archives">å½’æ¡£</a></li><li> <a href="/tags">æ ‡ç­¾</a></li><li> <a href="/about">å…³äº</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo.jpeg" style="width:220px; border-radius:110px" alt="favicon"><h3 title=""><a href="/">LH'BLOG</a></h3><div class="description"><p>keep learning</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/lhrun"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://segmentfault.com/u/lh_s"><i class="fa fa-segmentfault"></i></a></li></ul></div><details class="ltr" open><summary>ç›®å½•</summary><div class="tocmenu"><p><ol class="toclist"><li class="toclist-item toclist-level-2"><a class="toclist-link" href="#vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%88%86%E6%9E%90"><span class="toclist-number">1.</span> <span class="toclist-text">vue3å“åº”å¼åˆ†æ</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#reactive"><span class="toclist-number">1.1.</span> <span class="toclist-text">reactive</span></a></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#baseHandler"><span class="toclist-number">1.2.</span> <span class="toclist-text">baseHandler</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#get"><span class="toclist-number">1.2.1.</span> <span class="toclist-text">get</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#set"><span class="toclist-number">1.2.2.</span> <span class="toclist-text">set</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#deleteProperty%E3%80%81has%E2%80%A6"><span class="toclist-number">1.2.3.</span> <span class="toclist-text">deletePropertyã€hasâ€¦</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#collectionHandlers"><span class="toclist-number">1.3.</span> <span class="toclist-text">collectionHandlers</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#get-1"><span class="toclist-number">1.3.1.</span> <span class="toclist-text">get</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#size"><span class="toclist-number">1.3.2.</span> <span class="toclist-text">size</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#set-1"><span class="toclist-number">1.3.3.</span> <span class="toclist-text">set</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#has%E3%80%81clear%E2%80%A6"><span class="toclist-number">1.3.4.</span> <span class="toclist-text">hasã€clearâ€¦</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#effect"><span class="toclist-number">1.4.</span> <span class="toclist-text">effect</span></a><ol class="toclist-child"><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#effect-1"><span class="toclist-number">1.4.1.</span> <span class="toclist-text">effect</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#track"><span class="toclist-number">1.4.2.</span> <span class="toclist-text">track</span></a></li><li class="toclist-item toclist-level-4"><a class="toclist-link" href="#trigger"><span class="toclist-number">1.4.3.</span> <span class="toclist-text">trigger</span></a></li></ol></li><li class="toclist-item toclist-level-3"><a class="toclist-link" href="#%E6%80%BB%E7%BB%93"><span class="toclist-number">1.5.</span> <span class="toclist-text">æ€»ç»“</span></a></li></ol></li></ol></p></div></details></div><div class="footer"><div class="p"> <span> å…¨ç«™CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> LH_R</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo</a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>vue3å“åº”å¼åˆ†æ</a></h3></div><div class="post-content"><p><h2 id="vue3å“åº”å¼åˆ†æ"><a href="#vue3å“åº”å¼åˆ†æ" class="headerlink" title="vue3å“åº”å¼åˆ†æ"></a>vue3å“åº”å¼åˆ†æ</h2><ol>
<li>é¦–å…ˆå¯¹vue3å“åº”å¼åˆ†æä¹‹å‰ï¼Œéœ€è¦å¯¹å‰ç½®çŸ¥è¯†<code>Proxy</code>å’Œ<code>Reflect</code>æœ‰æ‰€äº†è§£ï¼Œï¼Œå…³äºè¿™ä¸¤ä¸ªçŸ¥è¯†æˆ‘æ¨èçœ‹é˜®ä¸€å³°è€å¸ˆçš„<a target="_blank" rel="noopener" href="https://es6.ruanyifeng.com/#README">ES6å…¥é—¨æ•™ç¨‹</a></li>
<li>vue3çš„å“åº”å¼æˆ‘æ˜¯ä»¥reactiveä¸ºå…¥å£è¿›è¡Œæ¢³ç†ï¼Œæµç¨‹å¦‚ä¸‹å›¾<br><img src="https://img-blog.csdnimg.cn/83a41b1d8a3044d6b8135850ea972ed1.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDcxOTI1OA==,size_16,color_FFFFFF,t_70#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></li>
<li>æºç ä½ç½®ï¼š<code>reactivity/src/...</code>ï¼Œåˆ†å››éƒ¨åˆ†è§£æ</li>
</ol>
<ul>
<li>reactiveæ–‡ä»¶ï¼šç›®æ ‡å¯¹è±¡è½¬åŒ–ä¸ºproxyå®ä¾‹</li>
<li>baseHandleræ–‡ä»¶ï¼šåŸºæœ¬ç±»å‹å¤„ç†å™¨</li>
<li>collectionHandlersæ–‡ä»¶ï¼šMapã€Setå¤„ç†å™¨</li>
<li>effectæ–‡ä»¶ï¼šæ”¶é›†è§¦å‘ä¾èµ–</li>
</ul>
<ol start="4">
<li>å¦‚æœä¸æƒ³çœ‹æºç è§£æï¼Œå¯ä»¥ç›´æ¥çœ‹æ€»ç»“ğŸ¶</li>
</ol>
<h3 id="reactive"><a href="#reactive" class="headerlink" title="reactive"></a>reactive</h3><ul>
<li><code>reactive</code>ï¼šå°†ä¸€ä¸ªJSå¯¹è±¡è½¬ä¸ºå…·æœ‰å“åº”å¼çš„proxyå®ä¾‹</li>
</ul>
<pre><code class="ts">export function reactive(target: object) &#123;
    // å¦‚æœæ˜¯åªè¯»æ•°æ®ï¼Œå°±ç›´æ¥è¿”å›
    if (target &amp;&amp; (target as Target)[ReactiveFlags.IS_READONLY]) &#123;
      return target
    &#125;
    return createReactiveObject(
      target,
      false,
      mutableHandlers,
      mutableCollectionHandlers,
      reactiveMap
    )
&#125;
</code></pre>
<ul>
<li><code>createReactiveObject</code></li>
</ul>
<pre><code class="ts">function createReactiveObject(
    target: Target, // æºå¯¹è±¡
    isReadonly: boolean, // æ˜¯å¦åªè¯»
    baseHandlers: ProxyHandler&lt;any&gt;, // åŸºæœ¬ç±»å‹çš„handlers
    collectionHandlers: ProxyHandler&lt;any&gt;, // ä¸»è¦é’ˆå¯¹(setã€mapã€weakSetã€weakMap)çš„handlers
    proxyMap: WeakMap&lt;Target, any&gt;
) &#123;
  // å¦‚æœä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç›´æ¥è¿”å›ï¼Œå¹¶ä¸”åœ¨å¼€å‘ç¯å¢ƒå‘å‡ºè­¦å‘Š
    if (!isObject(target)) &#123;
      if (__DEV__) &#123;
        console.warn(`value cannot be made reactive: $&#123;String(target)&#125;`)
      &#125;
      return target
    &#125;
    // å¦‚æœå·²ç»æ˜¯å“åº”å¼ï¼Œç›´æ¥è¿”å›
    if (
      target[ReactiveFlags.RAW] &amp;&amp;
      !(isReadonly &amp;&amp; target[ReactiveFlags.IS_REACTIVE])
    ) &#123;
      return target
    &#125;

    // å¦‚æœç›®æ ‡å¯¹è±¡å·²ç»å­˜åœ¨ä»£ç†ï¼Œç›´æ¥è¿”å›
    const existingProxy = proxyMap.get(target)
    if (existingProxy) &#123;
      return existingProxy
    &#125;

    // å¦‚æœç±»å‹å€¼ä¸æ˜¯Objectã€Arrayã€Mapã€Setã€WeakMapã€WeakSetçš„ï¼Œç›´æ¥è¿”å›
    const targetType = getTargetType(target)
    if (targetType === TargetType.INVALID) &#123;
      return target
    &#125;

    // æ ¹æ®ä¸åŒçš„ç±»å‹å€¼èµ‹äºˆä¸åŒçš„handlersï¼Œå°±æ˜¯æˆ‘ä¹‹å‰å›¾ä¸Šç”»çš„åˆ†å¼€å¤„ç†
    /* 
      æŠŠsetã€Mapè¿™ç§æ•°æ®ä¸åŸºç¡€æ•°æ®åˆ†å¼€å¤„ç†ï¼Œæ˜¯å› ä¸ºMapã€Setä¸­å­˜å‚¨çš„æ•°æ®å¿…é¡»é€šè¿‡thisè¿›è¡Œè®¿é—®
      ä½†æ˜¯è¢«proxyåŠ«æŒåï¼Œthiså°±å˜æˆäº†proxyï¼Œ
      æ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ï¼ŒæŠŠåŠ«æŒæ–¹æ³•è¿›è¡Œé‡å†™
     */
    const proxy = new Proxy(
      target,
      targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers
    )
    proxyMap.set(target, proxy)
    return proxy
  &#125;
</code></pre>
<h3 id="baseHandler"><a href="#baseHandler" class="headerlink" title="baseHandler"></a>baseHandler</h3><p><code>baseHandler</code>ä¸»è¦åˆ†æreactiveçš„å¤„ç†å™¨å¯¹è±¡<code>mutableHandlers</code></p>
<pre><code class="ts">// å¯¹get set delete has onwKeysåšäº†æ‹¦æˆªå¤„ç†
export const mutableHandlers: ProxyHandler&lt;object&gt; = &#123;
  get,
  set,
  deleteProperty,
  has,
  ownKeys
&#125;
</code></pre>
<h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><pre><code class="ts">function createGetter(isReadonly = false, shallow = false) &#123;
  return function get(target: Target, key: string | symbol, receiver: object) &#123;
    // è®¿é—®æ ‡å¿—ä½æ—¶çš„é€»è¾‘å¤„ç†
    if (key === ReactiveFlags.IS_REACTIVE) &#123;
      return !isReadonly
    &#125; else if (key === ReactiveFlags.IS_READONLY) &#123;
      return isReadonly
    &#125; else if (
      key === ReactiveFlags.RAW &amp;&amp;
      receiver ===
        (isReadonly
          ? shallow
            ? shallowReadonlyMap
            : readonlyMap
          : shallow
            ? shallowReactiveMap
            : reactiveMap
        ).get(target)
    ) &#123;
      return target
    &#125;

    const targetIsArray = isArray(target)

    // å¦‚æœtargetæ˜¯æ•°ç»„å¹¶ä¸”keyå±äºä¸€äº›æ•°ç»„çš„åŸå§‹æ–¹æ³•ï¼Œå³è§¦å‘æ‹¦æˆª
    if (!isReadonly &amp;&amp; targetIsArray &amp;&amp; hasOwn(arrayInstrumentations, key)) &#123;
      return Reflect.get(arrayInstrumentations, key, receiver)
    &#125;

    const res = Reflect.get(target, key, receiver)

    // å¦‚æœkeyæ˜¯symbolçš„å†…ç½®æ–¹æ³•ï¼Œæˆ–è€…æ˜¯åŸå‹å¯¹è±¡ï¼Œç›´æ¥è¿”å›
    if (isSymbol(key) ? builtInSymbols.has(key) : isNonTrackableKeys(key)) &#123;
      return res
    &#125;

    // åªè¯»å¯¹è±¡ä¸æ”¶é›†ä¾èµ–ï¼Œå› ä¸ºä¸ä¼šè§¦å‘ä¾èµ–æ›´æ–°
    if (!isReadonly) &#123;
      track(target, TrackOpTypes.GET, key)
    &#125;

    // æµ…å±‚å“åº”ç«‹å³è¿”å›ï¼Œä¸é€’å½’è½¬åŒ–
    if (shallow) &#123;
      return res
    &#125;

    // å¦‚æœæ˜¯refå¯¹è±¡(æ•°ç»„é™¤å¤–)ï¼Œè¿”å›çœŸæ­£çš„å€¼ï¼Œ
    if (isRef(res)) &#123;
      const shouldUnwrap = !targetIsArray || !isIntegerKey(key)
      return shouldUnwrap ? res.value : res
    &#125;

    if (isObject(res)) &#123;
      // ç”±äºproxyåªèƒ½ä»£ç†ä¸€å±‚ï¼Œæ‰€ä»¥target[key]çš„å€¼å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°±ç»§ç»­å¯¹å…¶è¿›è¡Œä»£ç†
      return isReadonly ? readonly(res) : reactive(res)
    &#125;
    return res
  &#125;
&#125;
</code></pre>
<p>æ•°ç»„æ–¹æ³•æ‹¦æˆª: å¯¹æ•°ç»„çš„ä¸¤ç§åŸç”Ÿæ–¹æ³•è¿›è¡Œäº†æ‹¦æˆª</p>
<ul>
<li>éå†æŸ¥æ‰¾çš„æ–¹æ³•ï¼šincludesã€indexOfã€lastIndexOf</li>
<li>æ”¹å˜æ•°ç»„é•¿åº¦çš„æ–¹æ³•ï¼špushã€popã€shiftã€unshiftã€splice</li>
</ul>
<pre><code class="ts">function createArrayInstrumentations() &#123;
    const instrumentations: Record&lt;string, Function&gt; = &#123;&#125;
    ;([&#39;includes&#39;, &#39;indexOf&#39;, &#39;lastIndexOf&#39;] as const).forEach(key =&gt; &#123;
      const method = Array.prototype[key] as any
      instrumentations[key] = function(this: unknown[], ...args: unknown[]) &#123;
        // è¿™ä¸€æ­¥æ˜¯ä¸ºäº†å–åŸå§‹å®ä¾‹ï¼Œå› ä¸ºå½“å‰çš„thisæ˜¯receiver
        const arr = toRaw(this)
        // æœé›†ä¾èµ–
        for (let i = 0, l = this.length; i &lt; l; i++) &#123;
          track(arr, TrackOpTypes.GET, i + &#39;&#39;)
        &#125;
        // è§¦å‘æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å€¼ï¼Œå°±å–åŸå§‹å€¼å†éå†
        const res = method.apply(arr, args)
        if (res === -1 || res === false) &#123;
          return method.apply(arr, args.map(toRaw))
        &#125; else &#123;
          return res
        &#125;
      &#125;
    &#125;)
    /* 
      å› ä¸ºæ”¹å˜æ•°ç»„é•¿åº¦çš„æ–¹æ³•ï¼Œæ‰§è¡ŒæœŸé—´ä¼šè§¦å‘lengthçš„getå’Œset
      å°±å›å¯¼è‡´æ— é™å¾ªç¯trackå’Œtrigger
      æ‰€ä»¥å°±ç”¨pauseTracking()ç¦ç”¨ä¾èµ–æ”¶é›†ï¼Œè§¦å‘æ–¹æ³•åï¼Œ
      å†ç”¨resetTracking()æ¢å¤track
     */
    ;([&#39;push&#39;, &#39;pop&#39;, &#39;shift&#39;, &#39;unshift&#39;, &#39;splice&#39;] as const).forEach(key =&gt; &#123;
      const method = Array.prototype[key] as any
      instrumentations[key] = function(this: unknown[], ...args: unknown[]) &#123;
        pauseTracking()
        const res = method.apply(this, args)
        resetTracking()
        return res
      &#125;
    &#125;)
    return instrumentations
&#125;
</code></pre>
<h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><pre><code class="ts">function createSetter(shallow = false) &#123;
  return function set(
    target: object,
    key: string | symbol,
    value: unknown,
    receiver: object
  ): boolean &#123;
    let oldValue = (target as any)[key]
    if (!shallow) &#123;
      value = toRaw(value)
      oldValue = toRaw(oldValue)
      // å¦‚æœåŸæ¥çš„å€¼æ˜¯refï¼Œä½†æ–°çš„å€¼ä¸æ˜¯ï¼Œåˆ™å°†æ–°çš„å€¼èµ‹ç»™oldValue.value
      if (!isArray(target) &amp;&amp; isRef(oldValue) &amp;&amp; !isRef(value)) &#123;
        oldValue.value = value
        return true
      &#125;
    &#125; else &#123;
      // in shallow mode, objects are set as-is regardless of reactive or not
    &#125;

    const hadKey =
      isArray(target) &amp;&amp; isIntegerKey(key)
        ? Number(key) &lt; target.length
        : hasOwn(target, key)
    const result = Reflect.set(target, key, value, receiver)
    
    // åˆ¤æ–­receiveræ˜¯å½“å‰å¯¹è±¡çš„proxyå®ä¾‹ï¼Œé˜²æ­¢åŸå‹é“¾ä¸Šçš„proxyè§¦å‘æ›´æ–°
    if (target === toRaw(receiver)) &#123;
      // åˆ¤æ–­æ–°å¢å±æ€§è¿˜æ˜¯ä¿®æ”¹å±æ€§
      if (!hadKey) &#123;
        trigger(target, TriggerOpTypes.ADD, key, value)
      &#125; else if (hasChanged(value, oldValue)) &#123;
        trigger(target, TriggerOpTypes.SET, key, value, oldValue)
      &#125;
    &#125;
    return result
  &#125;
&#125;
</code></pre>
<h4 id="deletePropertyã€hasâ€¦"><a href="#deletePropertyã€hasâ€¦" class="headerlink" title="deletePropertyã€hasâ€¦"></a>deletePropertyã€hasâ€¦</h4><ul>
<li>deletePropertyã€hasã€ownKeysçš„æºç å°±ä¸è´´äº†ï¼Œéƒ½æ˜¯åˆ¤æ–­keyçš„å±æ€§ï¼Œç„¶åé€‰æ‹©è§¦å‘æˆ–è€…æ”¶é›†ä¾èµ–</li>
</ul>
<h3 id="collectionHandlers"><a href="#collectionHandlers" class="headerlink" title="collectionHandlers"></a>collectionHandlers</h3><ul>
<li>collectionä¸»è¦åˆ†æreactiveçš„é‡å†™æ–¹æ³•å¯¹è±¡mutableInstrumentations</li>
</ul>
<pre><code class="ts">// ä¸»è¦å¯¹ä»¥ä¸‹åŸç”Ÿapiè¿›è¡Œäº†æ”¹å†™
const mutableInstrumentations: Record&lt;string, Function&gt; = &#123;
    get(this: MapTypes, key: unknown) &#123;
      return get(this, key)
    &#125;,
    get size() &#123;
      return size((this as unknown) as IterableCollections)
    &#125;,
    has,
    add,
    set,
    delete: deleteEntry,
    clear,
    forEach: createForEach(false, false)
&#125;
</code></pre>
<h4 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h4><pre><code class="ts">function get(
    target: MapTypes,
    key: unknown,
    isReadonly = false,
    isShallow = false
) &#123;
    // è·å–åŸå§‹å€¼é‡æ–°èµ‹å€¼ç»™target
    target = (target as any)[ReactiveFlags.RAW]

    // å¯¹targetæºå¯¹è±¡å’Œkeyè¿›ä¸€æ­¥è·å–åŸå§‹å€¼
    const rawTarget = toRaw(target)
    const rawKey = toRaw(key)

    // å½“å‰keyå’ŒåŸå§‹keyå‡è¿›è¡Œä¾èµ–æ”¶é›†(track)
    if (key !== rawKey) &#123;
      !isReadonly &amp;&amp; track(rawTarget, TrackOpTypes.GET, key)
    &#125;
    !isReadonly &amp;&amp; track(rawTarget, TrackOpTypes.GET, rawKey)
    const &#123; has &#125; = getProto(rawTarget)

    // è·å–å¯¹åº”çš„è½¬æ¢å‡½æ•°
    const wrap = isShallow ? toShallow : isReadonly ? toReadonly : toReactive
    /* 
      å¦‚æœæºå¯¹è±¡æœ‰keyå¯¹åº”çš„å±æ€§ï¼Œå°±é€šè¿‡åŸç”Ÿgetæ–¹æ³•å–åˆ°å€¼ï¼Œ
      å¹¶å¯¹è¯¥å€¼è¿›è¡Œå“åº”å¼è½¬æ¢ï¼Œè¿”å›è½¬æ¢åçš„å“åº”å¼å¯¹è±¡ï¼Œ
      å¦‚æœæ²¡æœ‰ï¼Œå°±å»keyåŸå§‹å€¼ä¸­å»æŸ¥æ‰¾
    */
    if (has.call(rawTarget, key)) &#123;
      return wrap(target.get(key))
    &#125; else if (has.call(rawTarget, rawKey)) &#123;
      return wrap(target.get(rawKey))
    &#125; else if (target !== rawTarget) &#123;
      target.get(key)
    &#125;
&#125;
</code></pre>
<h4 id="size"><a href="#size" class="headerlink" title="size"></a>size</h4><pre><code class="ts">// å¯¹sizeå±æ€§åšgetæ‹¦æˆª
function size(target: IterableCollections, isReadonly = false) &#123;
  target = (target as any)[ReactiveFlags.RAW]
  // è·å–sizeå’Œè·å–æ•°ç»„çš„lengthç±»ä¼¼ï¼Œéƒ½ç”¨ä¸“é—¨çš„keyåšä¾èµ–æ”¶é›†
  !isReadonly &amp;&amp; track(toRaw(target), TrackOpTypes.ITERATE, ITERATE_KEY)
  return Reflect.get(target, &#39;size&#39;, target)
&#125;
</code></pre>
<h4 id="set-1"><a href="#set-1" class="headerlink" title="set"></a>set</h4><pre><code class="ts">function set(this: MapTypes, key: unknown, value: unknown) &#123;
  // è·å–valueå’Œthisä¸Šä¸‹æ–‡çš„åŸå§‹å€¼
  value = toRaw(value)
  const target = toRaw(this)
  const &#123; has, get &#125; = getProto(target)

  /* 
    åˆ¤æ–­æºå¯¹è±¡æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„key
    1. é¦–å…ˆæŸ¥æ‰¾æºå¯¹è±¡æ˜¯å¦å·²æœ‰keyå¯¹åº”çš„å±æ€§
    2. å¦‚æœæ²¡æœ‰ï¼Œå†æŸ¥æ‰¾keyå¯¹åº”çš„åŸå§‹å€¼åœ¨æºå¯¹è±¡çš„å±æ€§æ˜¯å¦å­˜åœ¨
  */
  let hadKey = has.call(target, key)
  if (!hadKey) &#123;
    key = toRaw(key)
    hadKey = has.call(target, key)
  &#125; else if (__DEV__) &#123;
    checkIdentityKeys(target, has, key)
  &#125;

  const oldValue = get.call(target, key)
  target.set(key, value)

  // è§¦å‘ä¾èµ–ï¼Œæ–°å¢å±æ€§å’Œä¿®æ”¹å±æ€§åˆ†å¼€è¿›è¡Œtrigger
  if (!hadKey) &#123;
    trigger(target, TriggerOpTypes.ADD, key, value)
  &#125; else if (hasChanged(value, oldValue)) &#123;
    trigger(target, TriggerOpTypes.SET, key, value, oldValue)
  &#125;
  return this
&#125;
</code></pre>
<h4 id="hasã€clearâ€¦"><a href="#hasã€clearâ€¦" class="headerlink" title="hasã€clearâ€¦"></a>hasã€clearâ€¦</h4><ul>
<li>å…¶ä½™é‡å†™æ–¹æ³•æˆ‘å°±ä¸ä¸Šä»£ç äº†ï¼Œä¸åŒç‚¹æ˜¯å•ä¸ªå±æ€§è§¦å‘å•ä¸ªçš„ä¾èµ–ï¼Œå¦‚æœæ˜¯éå†æ‰€æœ‰å±æ€§çš„æ–¹æ³•å°±è§¦å‘æ‰€æœ‰ä¾èµ–</li>
</ul>
<h3 id="effect"><a href="#effect" class="headerlink" title="effect"></a>effect</h3><ul>
<li>effectæ–‡ä»¶ä½œä¸ºå“åº”å¼çš„æ ¸å¿ƒï¼Œä¸»è¦è´Ÿè´£æ”¶é›†ä¾èµ–ï¼Œè§¦å‘ä¾èµ–</li>
</ul>
<h4 id="effect-1"><a href="#effect-1" class="headerlink" title="effect"></a>effect</h4><ul>
<li>effectå‡½æ•°ä¸»è¦æ˜¯ç”Ÿæˆæ”¶é›†ä¾èµ–æ‰€éœ€çš„ä¾èµ–å‡½æ•°</li>
</ul>
<pre><code class="ts">export function effect&lt;T = any&gt;(
    fn: () =&gt; T,
    options: ReactiveEffectOptions = EMPTY_OBJ
): ReactiveEffect&lt;T&gt; &#123;
    // å¦‚æœå·²ç»æ˜¯effectå‡½æ•°ï¼Œå–å¾—åŸæ¥çš„fn
    if (isEffect(fn)) &#123;
      fn = fn.raw
    &#125;
    const effect = createReactiveEffect(fn, options)

    // å¦‚æœlazyä¸ºfalseï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡
    if (!options.lazy) &#123;
      effect()
    &#125;
    return effect
&#125;
</code></pre>
<ul>
<li><code>createReactiveEffect</code>ï¼šç”Ÿæˆeffectå¯¹è±¡</li>
</ul>
<pre><code class="ts">function createReactiveEffect&lt;T = any&gt;(
    fn: () =&gt; T,
    options: ReactiveEffectOptions
): ReactiveEffect&lt;T&gt; &#123;
    const effect = function reactiveEffect(): unknown &#123;
      // æ²¡æœ‰æ¿€æ´»ï¼Œå·²ç»è°ƒç”¨stopå‡½æ•°åœæ­¢ç›‘å¬
      if (!effect.active) &#123;
        return fn()
      &#125;
      /**
       * effectStackæ˜¯ä¸€ä¸ªå…¨å±€çš„effectæ ˆç»“æ„
       * è®¾è®¡ä¸ºæ ˆç»“æ„æ˜¯å› ä¸ºå¦‚æœeffectæ˜¯åµŒå¥—æ—¶ï¼Œä¸ºäº†é˜²æ­¢å†…å±‚å‰¯ä½œç”¨å‡½æ•°è¦†ç›–å¤–å±‚å‰¯ä½œç”¨å‡½æ•°ï¼Œåœ¨æ”¶é›†æ—¶åªæ”¶é›†æ ˆé¡¶çš„ï¼Œè¿™æ ·å°±ä¸ä¼šæ”¶é›†åˆ°é”™è¯¯çš„å‰¯ä½œç”¨å‡½æ•°
       */
      if (!effectStack.includes(effect)) &#123;
        /**
         * ä¸ºäº†ä¿è¯å½“å‰effectçš„depæ˜¯æœ€æ–°ï¼Œå› ä¸ºåœ¨ä¸€äº›åˆ¤æ–­å¤„ç†ä¸­ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ— æ•ˆçš„å‰¯ä½œç”¨å‡½æ•°
         * æ‰€ä»¥ä¸ºäº†å–æ¶ˆè¿™äº›ä¸å¿…è¦çš„æ›´æ–°ï¼Œå°±è¦æ¸…é™¤effectä¾èµ–
         */
        cleanup(effect)
        try &#123;
          enableTracking() // é‡æ–°æ”¶é›†ä¾èµ–
          effectStack.push(effect)
          activeEffect = effect
          return fn()
        &#125; finally &#123;
          /* 
            trackå°†ä¾èµ–å‡½æ•°activeEffectæ·»åŠ åˆ°å¯¹åº”çš„depä¸­ï¼Œ
            ç„¶åå°†activeEffecté‡ç½®ä¸ºä¸Šä¸€ä¸ªeffectçš„å€¼
          */
          effectStack.pop()
          resetTracking()
          activeEffect = effectStack[effectStack.length - 1]
        &#125;
      &#125;
    &#125; as ReactiveEffect
    effect.id = uid++ // è‡ªå¢ID
    effect.allowRecurse = !!options.allowRecurse // é€’å½’çŠ¶æ€
    effect._isEffect = true // ç”¨äºæ ‡è¯†æ–¹æ³•æ˜¯ä¸æ˜¯effect
    effect.active = true // ç”¨äºåˆ¤æ–­å½“å‰effectæ˜¯å¦æ¿€æ´»ï¼Œæœ‰ä¸€ä¸ªstop()æ¥å°†å®ƒè®¾ä¸ºfalse
    effect.raw = fn // effectçš„æ‰§è¡Œå‡½æ•°
    effect.deps = [] // ç”¨äºæ”¶é›†ä¾èµ–
    effect.options = options // åˆ›å»ºeffectä¼ å…¥çš„options
    return effect
&#125;
</code></pre>
<ul>
<li>activeEffectå°±æ˜¯æ ‡è®°trackæ‰€éœ€çš„ä¾èµ–å‡½æ•°</li>
</ul>
<h4 id="track"><a href="#track" class="headerlink" title="track"></a>track</h4><ul>
<li>trackå°±æ˜¯baseHandlerå’ŒcollectionHandlersæ–‡ä»¶ä¸­é¢‘ç¹ä½¿ç”¨çš„æ”¶é›†ä¾èµ–å‡½æ•°</li>
<li>é¦–å…ˆéœ€è¦çœ‹ä¸€ä¸ªå…³é”®å˜é‡targetMap</li>
</ul>
<pre><code class="ts">// targetMapæ˜¯ä¾èµ–ç®¡ç†ä¸­å¿ƒï¼Œæ”¶é›†ä¾èµ–å’Œè§¦å‘ä¾èµ–éƒ½ä¾æ‰˜äºè¿™ä¸ªMapæ•°æ®
// ä¸‹é¢æ˜¯targetMapçš„å®šä¹‰(target -&gt; key -&gt; dep)
// target: ç›‘å¬çš„å¯¹è±¡æº
// key: ç›‘å¬çš„é”®å€¼
// depï¼šä¾èµ–å‡½æ•°
type Dep = Set&lt;ReactiveEffect&gt;
type KeyToDepMap = Map&lt;any, Dep&gt;
const targetMap = new WeakMap&lt;any, KeyToDepMap&gt;()
// æ ¼å¼å¤§è‡´ä¸º
targetMap = &#123;
  target: &#123;
    key1: &#123; fn1, fn2 &#125;
    key2: &#123; fn1, fn2 &#125;
  &#125;
&#125;
</code></pre>
<pre><code class="ts">/**
 * @param &#123;target&#125; ç›®æ ‡å¯¹è±¡
 * @param &#123;type&#125; æ”¶é›†ç±»å‹
 * @param &#123;key&#125; éœ€è¦æ”¶é›†ä¾èµ–çš„key
 */
export function track(target: object, type: TrackOpTypes, key: unknown) &#123;
    // activeEffectä¸ºç©ºï¼Œå°±è¡¨ç¤ºå½“å‰æ²¡æœ‰ä¾èµ–ï¼Œå°±æ²¡å¿…è¦åšä¾èµ–æ”¶é›†äº†
    if (!shouldTrack || activeEffect === undefined) &#123;
      return
    &#125;
    // è·å–å½“å‰ä¾èµ–æ•°æ®
    let depsMap = targetMap.get(target)

    if (!depsMap) &#123;
      targetMap.set(target, (depsMap = new Map()))
    &#125;

    // å¦‚æœå½“å‰æ•°æ®ä¸­æ²¡æœ‰æ‰€å±çš„ä¾èµ–keyï¼Œå°±é‡æ–°è®¾ç½®ä¸€ä¸ª
    let dep = depsMap.get(key)
    if (!dep) &#123;
      depsMap.set(key, (dep = new Set()))
    &#125;
    // æ·»åŠ ä¾èµ–å‡½æ•°
    if (!dep.has(activeEffect)) &#123;
      dep.add(activeEffect)
      activeEffect.deps.push(dep)
      if (__DEV__ &amp;&amp; activeEffect.options.onTrack) &#123;
        activeEffect.options.onTrack(&#123;
          effect: activeEffect,
          target,
          type,
          key
        &#125;)
      &#125;
    &#125;
&#125;
</code></pre>
<h4 id="trigger"><a href="#trigger" class="headerlink" title="trigger"></a>trigger</h4><pre><code class="ts">// è§¦å‘ä¾èµ–
export function trigger(
  target: object,
  type: TriggerOpTypes,
  key?: unknown,
  newValue?: unknown,
  oldValue?: unknown,
  oldTarget?: Map&lt;unknown, unknown&gt; | Set&lt;unknown&gt;
) &#123;
  const depsMap = targetMap.get(target)
  // å¦‚æœæ²¡æœ‰æ”¶é›†è¿‡ä¾èµ–ï¼Œç›´æ¥è¿”å›
  if (!depsMap) &#123;
    return
  &#125;

  const effects = new Set&lt;ReactiveEffect&gt;()
  const add = (effectsToAdd: Set&lt;ReactiveEffect&gt; | undefined) =&gt; &#123;
    if (effectsToAdd) &#123;
      effectsToAdd.forEach(effect =&gt; &#123;
        // é¿å…å¾ªç¯è§¦å‘ä¾èµ– ç±»ä¼¼`effect(() =&gt; obj.foo++)`
        if (effect !== activeEffect || effect.allowRecurse) &#123;
          effects.add(effect)
        &#125;
      &#125;)
    &#125;
  &#125;

  if (type === TriggerOpTypes.CLEAR) &#123;
    // åœ¨æ¸…ç©ºå‰ï¼Œå°†å¯¹åº”çš„ä¾èµ–å…¨éƒ¨æ·»åŠ åˆ°å±€éƒ¨Set
    depsMap.forEach(add)
  &#125; else if (key === &#39;length&#39; &amp;&amp; isArray(target)) &#123;
    // å½“æ•°ç»„çš„lengthå±æ€§å˜åŒ–æ—¶è§¦å‘
    depsMap.forEach((dep, key) =&gt; &#123;
      if (key === &#39;length&#39; || key &gt;= (newValue as number)) &#123;
        add(dep)
      &#125;
    &#125;)
  &#125; else &#123;
    // schedule runs for SET | ADD | DELETE
    // å¾€ç›¸åº”é˜Ÿåˆ—æ·»åŠ ä¾èµ–
    if (key !== void 0) &#123;
      add(depsMap.get(key))
    &#125;

    // also run for iteration key on ADD | DELETE | Map.SET
    // é€šè¿‡ä¸åŒçš„TriggerOpTypeså°†depsMapçš„æ•°æ®å–å‡ºï¼Œæ·»åŠ åˆ°effects
    switch (type) &#123;
      case TriggerOpTypes.ADD:
        if (!isArray(target)) &#123;
          add(depsMap.get(ITERATE_KEY))
          if (isMap(target)) &#123;
            add(depsMap.get(MAP_KEY_ITERATE_KEY))
          &#125;
        &#125; else if (isIntegerKey(key)) &#123;
          // new index added to array -&gt; length changes
          add(depsMap.get(&#39;length&#39;))
        &#125;
        break
      case TriggerOpTypes.DELETE:
        if (!isArray(target)) &#123;
          add(depsMap.get(ITERATE_KEY))
          if (isMap(target)) &#123;
            add(depsMap.get(MAP_KEY_ITERATE_KEY))
          &#125;
        &#125;
        break
      case TriggerOpTypes.SET:
        if (isMap(target)) &#123;
          add(depsMap.get(ITERATE_KEY))
        &#125;
        break
    &#125;
  &#125;

  const run = (effect: ReactiveEffect) =&gt; &#123;
    if (__DEV__ &amp;&amp; effect.options.onTrigger) &#123;
      effect.options.onTrigger(&#123;
        effect,
        target,
        key,
        type,
        newValue,
        oldValue,
        oldTarget
      &#125;)
    &#125;
    if (effect.options.scheduler) &#123;
      // å¦‚æœæœ‰è°ƒåº¦å±æ€§ï¼Œå°±é€šè¿‡schedulerå¤„ç†æ‰§è¡Œ
      effect.options.scheduler(effect)
    &#125; else &#123;
      effect()
    &#125;
  &#125;

  effects.forEach(run)
&#125;
</code></pre>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>vue3å“åº”å¼æ˜¯é€šè¿‡æ•°æ®åŠ«æŒå’Œå‘å¸ƒè®¢é˜…çš„æ¨¡å¼è¿›è¡Œå¤„ç†ï¼Œé¦–å…ˆvue3ä¸­çš„æ•°æ®æ˜¯é€šè¿‡<code>proxy</code>åšäº†ä¸€å±‚ä»£ç†ï¼Œç„¶åå¤„ç†<code>proxy</code>çš„<code>handler</code>ï¼ŒåŸºæœ¬ç±»å‹çš„<code>handler</code>æ˜¯é€šè¿‡<code>baseHandlers</code>ï¼Œç‰¹æ®Šç±»å‹(mapï¼Œset)çš„<code>handler</code>æ˜¯é€šè¿‡<code>collectHandlers</code>ã€‚</li>
<li><code>handler</code>ä¸­è·å–å±æ€§çš„æ“ä½œé€šè¿‡<code>track</code>è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œä¿®æ”¹å±æ€§çš„æ“ä½œé€šè¿‡<code>trigger</code>è¿›è¡Œä¾èµ–è§¦å‘ï¼Œä¾èµ–çš„æ”¶é›†ä¸è§¦å‘æ˜¯é€šè¿‡ä¾èµ–ç®¡ç†ä¸­å¿ƒ<code>targetMap</code>ä¿å­˜çš„</li>
<li><code>track</code>è¿›è¡Œæ”¶é›†æ—¶ï¼Œä»–æ”¶é›†çš„æ˜¯<code>activeEffect</code>ï¼Œè¿™ä¸ªå˜é‡å­˜å‚¨çš„å°±æ˜¯æ­£åœ¨è§¦å‘çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œ<code>activeEffect</code>é€šè¿‡<code>effect()</code>æ–¹æ³•è¿›è¡Œæ”¶é›†</li>
<li><code>effect()</code>å¸¸ç”¨çš„ä¸‰ä¸ªåœ°æ–¹<ul>
<li>ç»„ä»¶å‰¯ä½œç”¨å‡½æ•°</li>
<li><code>watch</code></li>
<li><code>computed</code></li>
</ul>
</li>
</ul>
</p><div class="tip">æœ¬æ–‡é‡‡ç”¨CC-BY-SA-3.0åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„<br>ä½œè€…: LH_R</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-08-01</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue3/" title="Vue3">Vue3 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue/" title="Vue">Vue </a><span class="leancloud_visitors"></span><span>å¤§çº¦3070ä¸ªå­—, 10åˆ†é’Ÿ14ç§’è¯»å®Œ</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://example.com/2021/08/01/è§£æreactive-vue3å“åº”å¼/,LH'BLOG,vue3å“åº”å¼åˆ†æ,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2021/08/21/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8D%95%E6%8C%87%E6%8B%96%E6%8B%BD%E5%92%8C%E5%8F%8C%E6%8C%87%E7%BC%A9%E6%94%BE%E6%97%8B%E8%BD%AC/" title="å¾®ä¿¡å°ç¨‹åºå•æŒ‡æ‹–æ‹½å’ŒåŒæŒ‡ç¼©æ”¾æ—‹è½¬">ä¸Šä¸€ç¯‡</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2021/07/17/%E8%A7%A3%E6%9E%90nextTick-vue3%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" title="è§£ænextTick---vue3ä»»åŠ¡è°ƒåº¦">ä¸‹ä¸€ç¯‡</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'lhblog-1';
var disqus_identifier = '2021/08/01/è§£æreactive-vue3å“åº”å¼/';
var disqus_title = 'vue3å“åº”å¼åˆ†æ';
var disqus_url = 'http://example.com/2021/08/01/è§£æreactive-vue3å“åº”å¼/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="https://#{theme.disqus}.disqus.com/count.js" async></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"æ–‡ç« ",PAGES:"é¡µé¢",CATEGORIES:"åˆ†ç±»",TAGS:"æ ‡ç­¾",UNTITLED:"(æ— æ ‡é¢˜)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>