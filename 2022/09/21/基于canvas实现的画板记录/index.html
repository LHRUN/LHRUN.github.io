<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="songlh">







<title>基于canvas实现的画板记录 | LH&#39;BLOG</title>



    <link rel="icon" href="/favicon.png">



<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono&display=swap');
</style>



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    




    <!-- scripts list from _config.yml -->
    
    <script src="/js/frame.js"></script>
    










  <meta name="generator" content="Hexo 6.2.0"></head>
  <body>
    <div class="mask-border">
    </div>

    <div class="wrapper">

      <div class="header">
  <div class="flex-container">
    <div class="header-inner">
      <div class="site-brand-container">
        <a href="/">
          
            <img class="logo-img" src="/logo.png" alt="logo_image">
          
        </a>
      </div>
      <div id="menu-btn" class="menu-btn" onclick="toggleMenu()">
        Menu
      </div>
      <nav class="site-nav">
        <ul class="menu-list">
          
            
              <li class="menu-item">
                <a href="/">Home</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/categories/gallery/">Posts</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/archives/">Archive</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/tag/">Tag</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/about/">About</a>
              </li> 
                   
          
          
            <li class="menu-item search-btn">
              <a href="#">Search</a>
            </li>
          
        </ul>
      </nav>
    </div>
  </div>
</div>


      <div class="main">
        <div class="flex-container">
          <article id="post">

  
    <div class="post-head">
    <div class="post-info">
        <div class="tag-list">
            
                
                    <span class="post-tag">
                        <a href="/tags/canvas/">
                            canvas
                        </a>
                    </span>    
                           
            
        </div>
        <div class="post-title">
            
            
                基于canvas实现的画板记录
            
            
        </div>
        <span class="post-date">
            9月 21, 2022
        </span>
    </div>
    <div class="post-img">
        
            <img src="https://s1.ax1x.com/2022/09/11/vXAq2Q.jpg" alt="featured_image">
              
    </div>
</div>
    <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
<script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<div class="post-content">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近空闲时间比较多，就想做点小工具玩玩，方案选了好几个，最终决定做一个基于canvas的画板，目前已经完成了第一版，已完成以下功能</p>
<ol>
<li>画笔（动态宽度设置，颜色设置）</li>
<li>橡皮擦</li>
<li>撤回，反撤回，清除画板，保存</li>
<li>画板拖拽</li>
<li>多图层</li>
</ol>
<h2 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h2><p>目前实现效果如下<br><img src="https://s1.ax1x.com/2022/09/21/xiXVPK.png"><br>Demo预览地址：<a href="https://lhrun.github.io/paint-board/">https://lhrun.github.io/paint-board/</a><br>Github源码：<a target="_blank" rel="noopener" href="https://github.com/LHRUN/paint-board">https://github.com/LHRUN/paint-board</a></p>
<h2 id="画板设计"><a href="#画板设计" class="headerlink" title="画板设计"></a>画板设计</h2><ol>
<li>首先是建立一个canvas画板类，所有在canvas上的操作和canvas的信息全部都在这里处理，例如初始化，渲染，拖拽画板等等<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PaintBoard</span> &#123;</span><br><span class="line">  <span class="attr">canvas</span>: <span class="title class_">HTMLCanvasElement</span></span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">CanvasRenderingContext2D</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">canvas: HTMLCanvasElement</span>) &#123;</span><br><span class="line">    <span class="comment">// 初始化配置</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">initCanvas</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">  <span class="title function_">drag</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>然后基于canvas类，根据对应的操作类型，建立相应的canvas元素，比如画笔，橡皮擦，基本类型如下<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CanvasElement</span> &#123;</span><br><span class="line">  <span class="attr">type</span>: string <span class="comment">// 元素类型</span></span><br><span class="line">  <span class="attr">layer</span>: number <span class="comment">// 图层</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">type: string, layer: number</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = type</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">layer</span> = layer</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>然后根据这些渲染逻辑，还会封装一些通用的处理来改变canvas上最终的展示，比如缓存，历史操作，图层操作等等</li>
</ol>
<h2 id="画笔"><a href="#画笔" class="headerlink" title="画笔"></a>画笔</h2><ul>
<li>要实现画笔首先要建立一个画笔元素，然后在构造函数中接受基础宽度，颜色，初始化鼠标移动记录和线宽记录，因为我为了做撤回和图层等功能，所以需要对每个点都进行记录</li>
<li>为了体现鼠标移动快，线宽就变窄，移动慢，线宽就恢复正常这个效果，我会计算当前移动的速度，然后根据速度计算线宽<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FreeLine</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CanvasElement</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">color: string, width: number, layer: number</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">positions</span> = [] <span class="comment">// 鼠标移动位置记录</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lineWidths</span> = [<span class="number">0</span>] <span class="comment">// 线宽记录</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">color</span> = color <span class="comment">// 当前绘线颜色</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxWidth</span> = width <span class="comment">// 最大线宽</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">minWidth</span> = width / <span class="number">2</span> <span class="comment">// 最小线宽</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lastLineWidth</span> = width <span class="comment">// 最后绘线宽度</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>记录鼠标位置和当前线宽<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">MousePosition</span> &#123;</span><br><span class="line">  <span class="attr">x</span>: number</span><br><span class="line">  <span class="attr">y</span>: number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">addPosition</span>(<span class="params">position: MousePosition</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">positions</span>.<span class="title function_">push</span>(position)</span><br><span class="line">  <span class="comment">// 处理当前线宽</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> mouseSpeed = <span class="variable language_">this</span>.<span class="title function_">_computedSpeed</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">positions</span>[<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> - <span class="number">2</span>],</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">positions</span>[<span class="variable language_">this</span>.<span class="property">positions</span>.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> lineWidth = <span class="variable language_">this</span>.<span class="title function_">_computedLineWidth</span>(mouseSpeed)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lineWidths</span>.<span class="title function_">push</span>(lineWidth)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算移动速度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> start 起点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> end 终点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">_computedSpeed</span>(<span class="params">start: MousePosition, end: MousePosition</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取距离</span></span><br><span class="line">  <span class="keyword">const</span> moveDistance = <span class="title function_">getDistance</span>(start, end)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> curTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="comment">// 获取移动间隔时间   lastMoveTime：最后鼠标移动时间</span></span><br><span class="line">  <span class="keyword">const</span> moveTime = curTime - <span class="variable language_">this</span>.<span class="property">lastMoveTime</span></span><br><span class="line">  <span class="comment">// 计算速度</span></span><br><span class="line">  <span class="keyword">const</span> mouseSpeed = moveDistance / moveTime</span><br><span class="line">  <span class="comment">// 更新最后移动时间</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lastMoveTime</span> = curTime</span><br><span class="line">  <span class="keyword">return</span> mouseSpeed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算画笔宽度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> speed 鼠标移动速度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">_computedLineWidth</span>(<span class="params">speed: number</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> lineWidth = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> minWidth = <span class="variable language_">this</span>.<span class="property">minWidth</span></span><br><span class="line">  <span class="keyword">const</span> maxWidth = <span class="variable language_">this</span>.<span class="property">maxWidth</span></span><br><span class="line">  <span class="keyword">if</span> (speed &gt;= <span class="variable language_">this</span>.<span class="property">maxSpeed</span>) &#123;</span><br><span class="line">    lineWidth = minWidth</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (speed &lt;= <span class="variable language_">this</span>.<span class="property">minSpeed</span>) &#123;</span><br><span class="line">    lineWidth = maxWidth</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    lineWidth =</span><br><span class="line">      maxWidth -</span><br><span class="line">      ((speed - <span class="variable language_">this</span>.<span class="property">minSpeed</span>) / (<span class="variable language_">this</span>.<span class="property">maxSpeed</span> - <span class="variable language_">this</span>.<span class="property">minSpeed</span>)) * maxWidth</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lineWidth = lineWidth * (<span class="number">1</span> / <span class="number">3</span>) + <span class="variable language_">this</span>.<span class="property">lastLineWidth</span> * (<span class="number">2</span> / <span class="number">3</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lastLineWidth</span> = lineWidth</span><br><span class="line">  <span class="keyword">return</span> lineWidth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>保存记录后，渲染就是遍历所有记录<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">freeLineRender</span>(<span class="params"></span></span><br><span class="line"><span class="params">  context: CanvasRenderingContext2D,</span></span><br><span class="line"><span class="params">  instance: FreeLine</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  context.<span class="title function_">save</span>()</span><br><span class="line">  context.<span class="property">lineCap</span> = <span class="string">&#x27;round&#x27;</span></span><br><span class="line">  context.<span class="property">lineJoin</span> = <span class="string">&#x27;round&#x27;</span></span><br><span class="line">  context.<span class="property">strokeStyle</span> = instance.<span class="property">color</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; instance.<span class="property">positions</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">_drawLine</span>(instance, i, context)</span><br><span class="line">  &#125;</span><br><span class="line">  context.<span class="title function_">restore</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_drawLine</span>(<span class="params"></span></span><br><span class="line"><span class="params">  instance: FreeLine,</span></span><br><span class="line"><span class="params">  i: number,</span></span><br><span class="line"><span class="params">  context: CanvasRenderingContext2D</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; positions, lineWidths &#125; = instance</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">x</span>: centerX, <span class="attr">y</span>: centerY &#125; = positions[i - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">x</span>: endX, <span class="attr">y</span>: endY &#125; = positions[i]</span><br><span class="line">  context.<span class="title function_">beginPath</span>()</span><br><span class="line">  <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">    context.<span class="title function_">moveTo</span>(centerX, centerY)</span><br><span class="line">    context.<span class="title function_">lineTo</span>(endX, endY)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">x</span>: startX, <span class="attr">y</span>: startY &#125; = positions[i - <span class="number">2</span>]</span><br><span class="line">    <span class="keyword">const</span> lastX = (startX + centerX) / <span class="number">2</span></span><br><span class="line">    <span class="keyword">const</span> lastY = (startY + centerY) / <span class="number">2</span></span><br><span class="line">    <span class="keyword">const</span> x = (centerX + endX) / <span class="number">2</span></span><br><span class="line">    <span class="keyword">const</span> y = (centerY + endY) / <span class="number">2</span></span><br><span class="line">    context.<span class="title function_">moveTo</span>(lastX, lastY)</span><br><span class="line">    context.<span class="title function_">quadraticCurveTo</span>(centerX, centerY, x, y)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  context.<span class="property">lineWidth</span> = lineWidths[i]</span><br><span class="line">  context.<span class="title function_">stroke</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="橡皮擦"><a href="#橡皮擦" class="headerlink" title="橡皮擦"></a>橡皮擦</h2><ul>
<li>橡皮擦是一个线状擦除，我采用的方案是通过计算每个点的圆弧轨迹和两个点之间的矩形区域，然后通过clip剪切后清除<br><img src="https://s1.ax1x.com/2022/09/21/xivnHA.png"><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 橡皮擦渲染</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context canvas二维渲染上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cleanCanvas 清除画板</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> instance CleanLine</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanLineRender</span>(<span class="params"></span></span><br><span class="line"><span class="params">  context: CanvasRenderingContext2D,</span></span><br><span class="line"><span class="params">  cleanCanvas: () =&gt; <span class="keyword">void</span>,</span></span><br><span class="line"><span class="params">  instance: CleanLine</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; instance.<span class="property">positions</span>.<span class="property">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">_cleanLine</span>(</span><br><span class="line">      instance.<span class="property">positions</span>[i],</span><br><span class="line">      instance.<span class="property">positions</span>[i + <span class="number">1</span>],</span><br><span class="line">      context,</span><br><span class="line">      cleanCanvas,</span><br><span class="line">      instance.<span class="property">cleanWidth</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线状清除</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> start 起点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> end 终点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context canvas二维渲染上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cleanCanvas 清除画板</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cleanWidth 清楚宽度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_cleanLine</span>(<span class="params"></span></span><br><span class="line"><span class="params">  start: MousePosition,</span></span><br><span class="line"><span class="params">  end: MousePosition,</span></span><br><span class="line"><span class="params">  context: CanvasRenderingContext2D,</span></span><br><span class="line"><span class="params">  cleanCanvas: () =&gt; <span class="keyword">void</span>,</span></span><br><span class="line"><span class="params">  cleanWidth: number</span></span><br><span class="line"><span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">x</span>: x1, <span class="attr">y</span>: y1 &#125; = start</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">x</span>: x2, <span class="attr">y</span>: y2 &#125; = end</span><br><span class="line"></span><br><span class="line">  <span class="comment">//获取两个点之间的剪辑区域四个端点</span></span><br><span class="line">  <span class="keyword">const</span> asin = cleanWidth * <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>((y2 - y1) / (x2 - x1)))</span><br><span class="line">  <span class="keyword">const</span> acos = cleanWidth * <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>((y2 - y1) / (x2 - x1)))</span><br><span class="line">  <span class="keyword">const</span> x3 = x1 + asin</span><br><span class="line">  <span class="keyword">const</span> y3 = y1 - acos</span><br><span class="line">  <span class="keyword">const</span> x4 = x1 - asin</span><br><span class="line">  <span class="keyword">const</span> y4 = y1 + acos</span><br><span class="line">  <span class="keyword">const</span> x5 = x2 + asin</span><br><span class="line">  <span class="keyword">const</span> y5 = y2 - acos</span><br><span class="line">  <span class="keyword">const</span> x6 = x2 - asin</span><br><span class="line">  <span class="keyword">const</span> y6 = y2 + acos</span><br><span class="line"></span><br><span class="line">  <span class="comment">//保证线条的连贯，所以在矩形一端画圆</span></span><br><span class="line">  context.<span class="title function_">save</span>()</span><br><span class="line">  context.<span class="title function_">beginPath</span>()</span><br><span class="line">  context.<span class="title function_">arc</span>(x2, y2, cleanWidth, <span class="number">0</span>, <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span>)</span><br><span class="line">  context.<span class="title function_">clip</span>()</span><br><span class="line">  <span class="title function_">cleanCanvas</span>()</span><br><span class="line">  context.<span class="title function_">restore</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">//清除矩形剪辑区域里的像素</span></span><br><span class="line">  context.<span class="title function_">save</span>()</span><br><span class="line">  context.<span class="title function_">beginPath</span>()</span><br><span class="line">  context.<span class="title function_">moveTo</span>(x3, y3)</span><br><span class="line">  context.<span class="title function_">lineTo</span>(x5, y5)</span><br><span class="line">  context.<span class="title function_">lineTo</span>(x6, y6)</span><br><span class="line">  context.<span class="title function_">lineTo</span>(x4, y4)</span><br><span class="line">  context.<span class="title function_">closePath</span>()</span><br><span class="line">  context.<span class="title function_">clip</span>()</span><br><span class="line">  <span class="title function_">cleanCanvas</span>()</span><br><span class="line">  context.<span class="title function_">restore</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="撤回、反撤回"><a href="#撤回、反撤回" class="headerlink" title="撤回、反撤回"></a>撤回、反撤回</h2><ul>
<li>实现撤回，反撤回就要把canvas上的每个元素的渲染数据进行存储，然后通过当前步骤变量判断渲染到哪一步，这样就可以达到撤回效果</li>
<li>首先是建立一个history类，初始化缓存和step，然后撤回和反撤回，只需要修改step即可<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">History</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">cacheQueue</span>: T[]</span><br><span class="line">  <span class="attr">step</span>: number</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">cacheQueue: T[]</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cacheQueue</span> = cacheQueue</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">step</span> = cacheQueue.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加数据</span></span><br><span class="line">  <span class="title function_">add</span>(<span class="params">data: T</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果在回退时添加数据就删除暂存数据</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">step</span> !== <span class="variable language_">this</span>.<span class="property">cacheQueue</span>.<span class="property">length</span> - <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cacheQueue</span>.<span class="property">length</span> = <span class="variable language_">this</span>.<span class="property">step</span> + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cacheQueue</span>.<span class="title function_">push</span>(data)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">step</span> = <span class="variable language_">this</span>.<span class="property">cacheQueue</span>.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历cacheQueue</span></span><br><span class="line">  <span class="title function_">each</span>(<span class="params">cb?: (ele: T, i: number) =&gt; <span class="keyword">void</span></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= <span class="variable language_">this</span>.<span class="property">step</span>; i++) &#123;</span><br><span class="line">      cb?.(<span class="variable language_">this</span>.<span class="property">cacheQueue</span>[i], i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后退</span></span><br><span class="line">  <span class="title function_">undo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">step</span> &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">step</span>--</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cacheQueue</span>[<span class="variable language_">this</span>.<span class="property">step</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 前进</span></span><br><span class="line">  <span class="title function_">redo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">step</span> &lt; <span class="variable language_">this</span>.<span class="property">cacheQueue</span>.<span class="property">length</span> - <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">step</span>++</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cacheQueue</span>[<span class="variable language_">this</span>.<span class="property">step</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>然后针对画板，通过监听鼠标按下操作，就对history添加一个元素，然后对渲染函数的遍历限制到step就达到了撤回的效果<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PaintBoard</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 记录当前元素，并加入history</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">recordCurrent</span>(<span class="params">type: string</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">ele</span>: <span class="variable constant_">ELEMENT_INSTANCE</span> | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">CANVAS_ELE_TYPE</span>.<span class="property">FREE_LINE</span>:</span><br><span class="line">        ele = <span class="keyword">new</span> <span class="title class_">FreeLine</span>(</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">currentLineColor</span>,</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">currentLineWidth</span>,</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="property">current</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">CANVAS_ELE_TYPE</span>.<span class="property">CLEAN_LINE</span>:</span><br><span class="line">        ele = <span class="keyword">new</span> <span class="title class_">CleanLine</span>(<span class="variable language_">this</span>.<span class="property">cleanWidth</span>, <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="property">current</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ele) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">add</span>(ele)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentEle</span> = ele</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 遍历history渲染数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 清除画布</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">cleanCanvas</span>()</span><br><span class="line">    <span class="comment">// 遍历history</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">each</span>(<span class="function">(<span class="params">ele</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">save</span>()</span><br><span class="line">      <span class="comment">// render....</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">context</span>,<span class="title function_">resore</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 缓存数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">cache</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="拖拽画布"><a href="#拖拽画布" class="headerlink" title="拖拽画布"></a>拖拽画布</h2><ul>
<li>拖拽画布的实现是通过计算鼠标移动距离，然后根据距离改变画布的原点位置，就达到拖拽的效果</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">drag</span>(<span class="params">position: MousePosition</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> mousePosition = &#123;</span><br><span class="line">    <span class="attr">x</span>: position.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">canvasRect</span>.<span class="property">left</span>,</span><br><span class="line">    <span class="attr">y</span>: position.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">canvasRect</span>.<span class="property">top</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">originPosition</span>.<span class="property">x</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">originPosition</span>.<span class="property">y</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> translteX = mousePosition.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">originPosition</span>.<span class="property">x</span></span><br><span class="line">    <span class="keyword">const</span> translteY = mousePosition.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">originPosition</span>.<span class="property">y</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">translate</span>(translteX, translteY)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">originTranslate</span> = &#123;</span><br><span class="line">      <span class="attr">x</span>: translteX + <span class="variable language_">this</span>.<span class="property">originTranslate</span>.<span class="property">x</span>,</span><br><span class="line">      <span class="attr">y</span>: translteY + <span class="variable language_">this</span>.<span class="property">originTranslate</span>.<span class="property">y</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">render</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">originPosition</span> = mousePosition</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多图层"><a href="#多图层" class="headerlink" title="多图层"></a>多图层</h2><p>实现多图层需要对以下几个地方进行处理</p>
<ol>
<li>建立图层类，所有的图层数据和图层逻辑全都放在此处</li>
<li>然后对canvas上的元素加layer属性，用于判断归属于哪个图层</li>
<li>画板的渲染函数改为按照图层顺序进行渲染</li>
<li>拖拽或者隐藏图层都需要重新渲染，删除图层把对应的缓存图层元素进行删除</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">ILayer</span> &#123;</span><br><span class="line">  <span class="attr">id</span>: number <span class="comment">// 图层id</span></span><br><span class="line">  <span class="attr">title</span>: string <span class="comment">// 图层名称</span></span><br><span class="line">  <span class="attr">show</span>: boolean <span class="comment">// 图层展示状态</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Layer</span> &#123;</span><br><span class="line">  <span class="attr">stack</span>: <span class="title class_">ILayer</span>[] <span class="comment">// 图层数据</span></span><br><span class="line">  <span class="attr">current</span>: number <span class="comment">// 当前图层</span></span><br><span class="line">  <span class="attr">render</span>: <span class="function">() =&gt;</span> <span class="keyword">void</span> <span class="comment">// 画板渲染事件</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">render: () =&gt; <span class="keyword">void</span>, initData?: Layer</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      stack = [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">title</span>: <span class="string">&#x27;item1&#x27;</span>,</span><br><span class="line">          <span class="attr">show</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      id = <span class="number">1</span>,</span><br><span class="line">      current = <span class="number">1</span></span><br><span class="line">    &#125; = initData || &#123;&#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stack</span> = stack</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">current</span> = current</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">render</span> = render</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PaintBoard</span> &#123;</span><br><span class="line">  <span class="comment">// 通过图层进行排序</span></span><br><span class="line">   <span class="title function_">sortOnLayer</span>(<span class="params"></span>) &#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> (</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="property">stack</span>.<span class="title function_">findIndex</span>(<span class="function">(<span class="params">&#123; id &#125;</span>) =&gt;</span> id === b?.<span class="property">layer</span>) -</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="property">stack</span>.<span class="title function_">findIndex</span>(<span class="function">(<span class="params">&#123; id &#125;</span>) =&gt;</span> id === a?.<span class="property">layer</span>)</span><br><span class="line">       )</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 渲染函数只渲染图层展示状态的元素</span></span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">     <span class="keyword">const</span> showLayerIds = <span class="keyword">new</span> <span class="title class_">Set</span>(</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">layer</span>.<span class="property">stack</span>.<span class="property">reduce</span>&lt;number[]&gt;(<span class="function">(<span class="params">acc, cur</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> cur.<span class="property">show</span> ? [...acc, cur.<span class="property">id</span>] : acc</span><br><span class="line">       &#125;, [])</span><br><span class="line">     )</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">each</span>(<span class="function">(<span class="params">ele</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (ele?.<span class="property">layer</span> &amp;&amp; showLayerIds.<span class="title function_">has</span>(ele.<span class="property">layer</span>)) &#123;</span><br><span class="line">         ...</span><br><span class="line">       &#125;</span><br><span class="line">     &#125; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>我上面分析了主要思路，还有一些小问题或者一些特殊情况就需要针对性处理，比如窗口变化，浏览器兼容等等</li>
<li>这个画板写下来大概用了一个星期，有好多功能还没写上，如果过段时间有空的话就继续写下去，并进一步优化，现在还是有点优化问题没有写好，比如动态宽度显示的还是有点问题，原点位置和一些初始化设计的不太好，不过写完这个画板还是挺有成就感的</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/axes/p/3850309.html">HTML5 实现橡皮擦的擦除效果</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7091276963146530847">我做了一个在线白板！</a></li>
</ul>

</div> 

<script>
    window.onload = detectors();
</script>
    <div class="post-footer">
    <div class="h-line-primary"></div>
    <nav class="post-nav">
        <div class="prev-item">
           
        </div>
        <div class="next-item">
            
                <div class="icon arrow-right"></div>
                <div class="post-link">
                  <a href="/2022/09/10/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%89%8D%E7%AB%AF%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1/">Next</a>  
                </div>  
            
        </div>
    </nav>
</div>

    
      <div class="post-comment">

     

    
        <div id="disqus_thread"></div>
        <script>
            /**
            *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
            *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
            
            var disqus_config = function () {
                this.page.url = 'https://lhrun.github.io/2022/09/21/%E5%9F%BA%E4%BA%8Ecanvas%E5%AE%9E%E7%8E%B0%E7%9A%84%E7%94%BB%E6%9D%BF%E8%AE%B0%E5%BD%95/';  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = '2022/09/21/基于canvas实现的画板记录/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                this.language = 'en'
            };
            
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://lhblog-1.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>   
     
    
    

</div>
     
  
</article>
        </div>
      </div>
      
      <div class="footer">
    <div class="flex-container">
        <div class="footer-text">
            
            
            
                Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
                
        </div>
    </div>
</div>

    </div>

    
      <div class="search-popup">
    <div class="search-popup-overlay">  
    </div>
    <div class="search-popup-window" >
        <div class="search-header">
            <div class="search-input-container">
              <input autocomplete="off" autocapitalize="off" maxlength="80"
                     placeholder="Search Anything" spellcheck="false"
                     type="search" class="search-input">
            </div>
            <div class="search-close-btn">
                <div class="icon close-btn"></div>
            </div>
        </div>
        <div class="search-result-container">
        </div>
    </div>
</div>

<script>
    const searchConfig = {
        path             : "/search.xml",
        top_n_per_article: "1",
        unescape         : "false",
        trigger: "auto",
        preload: "false"
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script>
<script src="/js/search.js"></script>
    
    

  </body>
</html>
